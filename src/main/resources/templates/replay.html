<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¦¬í”Œë ˆì´ - ë¯¸ë¡œì°¾ê¸°</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .maze-text {
            font-family: 'Courier New', monospace;
            white-space: pre;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            border-radius: 5px;
            font-size: 18px;
            line-height: 1.2;
        }
        .panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        select, input {
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        .meta {
            margin-top: 10px;
            color: #475569;
            line-height: 1.5;
        }
        .message-box {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            background: #fff;
            border: 1px solid #e2e8f0;
            color: #334155;
            min-height: 42px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¼ ë¦¬í”Œë ˆì´</h1>
            <p>ì €ì¥ëœ ê²Œì„ ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì™€ ì¡°ì‘ ê³¼ì •ì„ ì¬ìƒí•©ë‹ˆë‹¤.</p>
        </div>

        <div class="panel">
            <div class="controls">
                <label for="logSelect"><strong>ë¡œê·¸ íŒŒì¼</strong></label>
                <select id="logSelect">
                    <option value="">(ì„ íƒ)</option>
                    <option th:each="f : ${logFiles}" th:value="${f}" th:text="${f}"></option>
                </select>

                <label for="speed"><strong>ì†ë„(ë°°ìˆ˜)</strong></label>
                <input id="speed" type="number" min="0.1" step="0.1" value="1.0" style="width: 90px;">

                <button class="btn btn-primary" onclick="loadFrames()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button class="btn btn-secondary" onclick="play()">ì¬ìƒ</button>
                <button class="btn btn-danger" onclick="pause()">ì¼ì‹œì •ì§€</button>
                <button class="btn" onclick="stepOnce()">í•œ í”„ë ˆì„</button>
                <a class="btn btn-primary" href="/" style="text-decoration:none;">ë©”ì¸</a>
            </div>

            <div class="meta" id="metaBox">
                ì„ íƒëœ ë¡œê·¸: <span id="selectedFile">(ì—†ìŒ)</span> /
                í”„ë ˆì„: <span id="frameCount">0</span> /
                í˜„ì¬: <span id="currentIndex">0</span>
            </div>

            <div class="message-box" id="messageBox">ë¶ˆëŸ¬ì˜¨ ë’¤ ì¬ìƒì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
        </div>

        <div class="panel">
            <div class="maze-text" id="mazeText">ì—¬ê¸°ì— ë¦¬í”Œë ˆì´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
    </div>

    <script th:inline="javascript">
        const preselected = /*[[${selectedLogFile}]]*/ null;
        const logSelect = document.getElementById('logSelect');
        if (preselected) {
            logSelect.value = preselected;
        }

        let frames = [];
        let idx = 0;
        let playing = false;
        let timerId = null;

        function renderFrame(i) {
            if (!frames || frames.length === 0) return;
            const f = frames[Math.max(0, Math.min(i, frames.length - 1))];
            const mazeText = document.getElementById('mazeText');
            const messageBox = document.getElementById('messageBox');
            const currentIndex = document.getElementById('currentIndex');
            if (mazeText) mazeText.textContent = f.mazeView || '';
            if (messageBox) messageBox.textContent = `${f.index}. ${f.eventType}(${f.direction || ' '}) | ${f.message || ''}`;
            if (currentIndex) currentIndex.textContent = String(f.index);
        }

        function loadFrames() {
            pause();
            const file = logSelect.value;
            document.getElementById('selectedFile').textContent = file || '(ì—†ìŒ)';
            fetch('/replay/frames?file=' + encodeURIComponent(file || ''))
                .then(r => r.json())
                .then(data => {
                    frames = (data.frames || []);
                    idx = 0;
                    document.getElementById('frameCount').textContent = String(frames.length);
                    if (frames.length > 0) {
                        renderFrame(0);
                    } else {
                        document.getElementById('mazeText').textContent = 'í”„ë ˆì„ì´ ì—†ìŠµë‹ˆë‹¤. (ë¡œê·¸ íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”)';
                        document.getElementById('messageBox').textContent = data && data.file ? `ë¡œë“œ ì‹¤íŒ¨: ${data.file}` : 'ë¡œë“œ ì‹¤íŒ¨';
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('messageBox').textContent = 'ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                });
        }

        function getSpeed() {
            const v = parseFloat(document.getElementById('speed').value);
            return (isFinite(v) && v > 0) ? v : 1.0;
        }

        function scheduleNext() {
            if (!playing) return;
            if (!frames || frames.length === 0) return;
            if (idx >= frames.length - 1) {
                playing = false;
                return;
            }

            const speed = getSpeed();
            const cur = frames[idx];
            const next = frames[idx + 1];
            const dt = Math.max(80, Math.min(1500, (next.offsetMillis - cur.offsetMillis) / speed)); // 80~1500msë¡œ í´ë¨í”„

            timerId = setTimeout(() => {
                if (!playing) return;
                idx++;
                renderFrame(idx);
                scheduleNext();
            }, dt);
        }

        function play() {
            if (!frames || frames.length === 0) {
                loadFrames();
                return;
            }
            if (playing) return;
            playing = true;
            scheduleNext();
        }

        function pause() {
            playing = false;
            if (timerId) {
                clearTimeout(timerId);
                timerId = null;
            }
        }

        function stepOnce() {
            pause();
            if (!frames || frames.length === 0) return;
            idx = Math.min(idx + 1, frames.length - 1);
            renderFrame(idx);
        }

        // í˜ì´ì§€ ì§„ì… ì‹œ ìë™ ë¡œë“œ(ìµœê·¼ ë¡œê·¸ê°€ ìˆìœ¼ë©´)
        if (preselected) {
            loadFrames();
        }
    </script>
</body>
</html>

