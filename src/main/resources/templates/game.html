<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì„ ì§„í–‰ ì¤‘ - ë¯¸ë¡œì°¾ê¸°</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <div class="container">
        <div class="game-header">
            <h1>ğŸ® ë¯¸ë¡œì°¾ê¸° ê²Œì„</h1>
            <div class="player-info">
                <div class="player-status">
                    <span class="player-label">ë‚˜ (â€»):</span>
                    <span th:if="${playerMe.reachedGoal}" class="status-success">âœ“ ë„ì°© ì™„ë£Œ!</span>
                    <span th:unless="${playerMe.reachedGoal}" class="status-playing">ì§„í–‰ ì¤‘...</span>
                    <span th:if="${playerMe.hasItem}" class="item-badge">â˜… ì•„ì´í…œ ë³´ìœ </span>
                </div>
                <div class="player-status">
                    <span class="player-label">AI (â—‹):</span>
                    <span th:if="${playerYou.reachedGoal}" class="status-success">âœ“ ë„ì°© ì™„ë£Œ!</span>
                    <span th:unless="${playerYou.reachedGoal}" class="status-playing">ì§„í–‰ ì¤‘...</span>
                    <span th:if="${playerYou.hasItem}" class="item-badge">â˜… ì•„ì´í…œ ë³´ìœ </span>
                </div>
            </div>
        </div>
        
        <div class="game-container">
            <div class="maze-container">
                <div id="maze" class="maze" th:attr="data-size=${mazeData.size}">
                    <!-- ë¯¸ë¡œê°€ JavaScriptë¡œ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>
            
            <div class="controls-panel">
                <h3>ì¡°ì‘</h3>
                <div class="control-buttons">
                    <button class="btn-direction" onclick="move('UP')">â†‘ ìœ„</button>
                    <div class="horizontal-buttons">
                        <button class="btn-direction" onclick="move('LEFT')">â† ì™¼ìª½</button>
                        <button class="btn-direction" onclick="move('DOWN')">â†“ ì•„ë˜</button>
                        <button class="btn-direction" onclick="move('RIGHT')">â†’ ì˜¤ë¥¸ìª½</button>
                    </div>
                </div>
                <div class="keyboard-hint">
                    <small>í‚¤ë³´ë“œ: WASD ë˜ëŠ” í™”ì‚´í‘œ í‚¤ ì‚¬ìš©</small>
                </div>
                
                <div class="game-actions">
                    <form th:action="@{/game/reset}" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-danger">ê²Œì„ ì¢…ë£Œ</button>
                    </form>
                </div>
            </div>
            
            <div class="log-panel">
                <h3>ê²Œì„ ë¡œê·¸</h3>
                <div id="gameLog" class="log-content">
                    <div th:each="log : ${gameLog}" th:text="${log}" class="log-entry"></div>
                </div>
            </div>
        </div>
        
        <div class="game-over-modal" id="gameOverModal" style="display: none;">
            <div class="modal-content">
                <h2>ğŸ‰ ê²Œì„ ì™„ë£Œ!</h2>
                <p>ë„ì°©ì§€ì ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤! ê²Œì„ ì™„ë£Œ!</p>
                <form th:action="@{/game/reset}" method="post">
                    <button type="submit" class="btn btn-primary">ìƒˆ ê²Œì„ ì‹œì‘</button>
                </form>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ë¯¸ë¡œ ë°ì´í„°
        const mazeData = /*[[${mazeData}]]*/ {};
        const gameLog = /*[[${gameLog}]]*/ [];
        
        // ë¯¸ë¡œ ë Œë”ë§
        function renderMaze() {
            const mazeDiv = document.getElementById('maze');
            const size = mazeData.size;
            const cells = mazeData.cells;
            
            mazeDiv.innerHTML = '';
            mazeDiv.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const cell = cells[i][j];
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'maze-cell';
                    
                    // ê°€ì‹œì„± í™•ì¸
                    if (!cell.visible) {
                        cellDiv.classList.add('fog');
                    } else {
                        // ì…€ íƒ€ì…ì— ë”°ë¥¸ í´ë˜ìŠ¤ ì¶”ê°€
                        const code = cell.code;
                        if (code === 0) cellDiv.classList.add('start');
                        else if (code === 3) cellDiv.classList.add('path');
                        else if (code === 4) cellDiv.classList.add('wall');
                        else if (code === 5) cellDiv.classList.add('fog'); // ì•ˆê°œ
                        else if (code === 6) cellDiv.classList.add('item');
                        else if (code === 7) cellDiv.classList.add('path'); // ê¸°íƒ€ ì½”ë“œëŠ” ê¸¸ë¡œ ì²˜ë¦¬
                        else if (code === 8) cellDiv.classList.add('path'); // ê¸°íƒ€ ì½”ë“œëŠ” ê¸¸ë¡œ ì²˜ë¦¬
                        else if (code === 9) cellDiv.classList.add('goal');
                        else cellDiv.classList.add('path'); // ì•Œ ìˆ˜ ì—†ëŠ” ì½”ë“œëŠ” ê¸¸ë¡œ ì²˜ë¦¬
                    }
                    
                    // í”Œë ˆì´ì–´ í‘œì‹œ
                    if (cell.playerMe) {
                        cellDiv.classList.add('player-me');
                        cellDiv.textContent = 'â€»';
                    } else if (cell.playerYou) {
                        cellDiv.classList.add('player-you');
                        cellDiv.textContent = 'â—‹';
                    }
                    
                    mazeDiv.appendChild(cellDiv);
                }
            }
        }
        
        // ì´ë™ í•¨ìˆ˜
        function move(direction) {
            fetch('/game/move', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'direction=' + direction
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ë¯¸ë¡œ ë°ì´í„° ì—…ë°ì´íŠ¸
                    mazeData.size = data.mazeData.size;
                    mazeData.cells = data.mazeData.cells;
                    
                    // ë¯¸ë¡œ ë‹¤ì‹œ ë Œë”ë§
                    renderMaze();
                    
                    // ë¡œê·¸ ì—…ë°ì´íŠ¸
                    updateLog(data.gameLog);
                    
                    // ê²Œì„ ì¢…ë£Œ í™•ì¸
                    if (data.gameFinished) {
                        if (aiMoveInterval) {
                            clearInterval(aiMoveInterval);
                        }
                        const gameOverModal = document.getElementById('gameOverModal');
                        if (gameOverModal) {
                            gameOverModal.style.display = 'flex';
                        }
                    }
                } else {
                    alert(data.message || 'ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }
        
        // ë¡œê·¸ ì—…ë°ì´íŠ¸
        function updateLog(logs) {
            const logDiv = document.getElementById('gameLog');
            logDiv.innerHTML = '';
            logs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = log;
                logDiv.appendChild(logEntry);
            });
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
        document.addEventListener('keydown', function(e) {
            const key = e.key.toLowerCase();
            if (e.key === 'ArrowUp' || key === 'w') {
                e.preventDefault();
                move('UP');
            } else if (e.key === 'ArrowDown' || key === 's') {
                e.preventDefault();
                move('DOWN');
            } else if (e.key === 'ArrowLeft' || key === 'a') {
                e.preventDefault();
                move('LEFT');
            } else if (e.key === 'ArrowRight' || key === 'd') {
                e.preventDefault();
                move('RIGHT');
            }
        });
        
        // AI ìë™ ì´ë™
        let aiMoveInterval = null;
        
        function startAIMovement() {
            if (aiMoveInterval) {
                clearInterval(aiMoveInterval);
            }
            aiMoveInterval = setInterval(function() {
                fetch('/game/ai-move', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // ë¯¸ë¡œ ë°ì´í„° ì—…ë°ì´íŠ¸
                        mazeData.size = data.mazeData.size;
                        mazeData.cells = data.mazeData.cells;
                        
                        // ë¯¸ë¡œ ë‹¤ì‹œ ë Œë”ë§
                        renderMaze();
                        
                        // ë¡œê·¸ ì—…ë°ì´íŠ¸
                        updateLog(data.gameLog);
                        
                        // ê²Œì„ ì¢…ë£Œ í™•ì¸
                        if (data.gameFinished) {
                            clearInterval(aiMoveInterval);
                            const gameOverModal = document.getElementById('gameOverModal');
                            if (gameOverModal) {
                                gameOverModal.style.display = 'flex';
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('AI Move Error:', error);
                });
            }, 1000); // 1ì´ˆë§ˆë‹¤ AI ì´ë™
        }
        
        // ì´ˆê¸° ë Œë”ë§
        renderMaze();
        updateLog(gameLog);
        
        // AI ìë™ ì´ë™ ì‹œì‘
        startAIMovement();
        
        // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ ì¸í„°ë²Œ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            if (aiMoveInterval) {
                clearInterval(aiMoveInterval);
            }
        });
    </script>
</body>
</html>

