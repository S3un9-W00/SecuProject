<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì„ ì§„í–‰ ì¤‘ - ë¯¸ë¡œì°¾ê¸°</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .maze-text {
            font-family: 'Courier New', monospace;
            white-space: pre;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            border-radius: 5px;
            font-size: 18px;
            line-height: 1.2;
        }
        .game-info {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        .message-box {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            background: #fff;
            border: 1px solid #e2e8f0;
            color: #334155;
            min-height: 42px;
        }
        .legend {
            margin-top: 12px;
            font-size: 0.95em;
            color: #475569;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-header">
            <h1>ğŸ® ë¯¸ë¡œì°¾ê¸° ê²Œì„</h1>
            <div class="game-info">
                <p><strong>í”Œë ˆì´ì–´ ìœ„ì¹˜:</strong> (<span th:text="${status.playerX}">0</span>, <span th:text="${status.playerY}">0</span>)</p>
                <p><strong>AI ìœ„ì¹˜:</strong> (<span th:text="${status.enemyX}">0</span>, <span th:text="${status.enemyY}">0</span>)</p>
                <p th:if="${status.gameFinished}" style="color: green; font-weight: bold;">âœ“ ê²Œì„ ì™„ë£Œ!</p>
                <p th:unless="${status.gameFinished}" style="color: blue;">ì§„í–‰ ì¤‘...</p>
                <div class="message-box" id="messageBox">ì´ë™/ì•„ì´í…œ/í•¨ì • ê²°ê³¼ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                <div class="legend">
                    <strong>ë²”ë¡€</strong>:
                    P=í”Œë ˆì´ì–´, E=AI, #=ë²½, .=ê¸¸, G=ë„ì°©,
                    F=íšƒë¶ˆ(10ì´ˆ 5Ã—5 ì‹œì•¼), H=ë§ì¹˜(ë²½ 1íšŒ íŒŒê´´), X=í•¨ì •(3ì´ˆ ì´ë™ ë¶ˆê°€)
                </div>
            </div>
        </div>
        
        <div class="game-container">
            <div class="maze-container">
                <div class="maze-text" th:text="${status.mazeView}">
                    <!-- ë¯¸ë¡œê°€ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
            
            <div class="controls-panel">
                <h3>ì¡°ì‘</h3>
                <div class="control-buttons">
                    <button class="btn-direction" onclick="move('w')">â†‘ ìœ„ (W)</button>
                    <div class="horizontal-buttons">
                        <button class="btn-direction" onclick="move('a')">â† ì™¼ìª½ (A)</button>
                        <button class="btn-direction" onclick="move('s')">â†“ ì•„ë˜ (S)</button>
                        <button class="btn-direction" onclick="move('d')">â†’ ì˜¤ë¥¸ìª½ (D)</button>
                    </div>
                </div>
                <div class="keyboard-hint">
                    <small>í‚¤ë³´ë“œ: WASD ì‚¬ìš©</small>
                </div>
                
                <div class="game-actions">
                    <form th:action="@{/game/reset}" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-danger">ê²Œì„ ì¢…ë£Œ</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="game-over-modal" id="gameOverModal" style="display: none;">
            <div class="modal-content">
                <h2>ğŸ‰ ê²Œì„ ì™„ë£Œ!</h2>
                <p>ë„ì°©ì§€ì ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!</p>
                <form th:action="@{/game/reset}" method="post">
                    <button type="submit" class="btn btn-primary">ìƒˆ ê²Œì„ ì‹œì‘</button>
                </form>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        // ì´ë™ í•¨ìˆ˜
        function move(direction) {
            fetch('/game/move', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'direction=' + direction
            })
            .then(response => response.json())
            .then(data => {
                const messageBox = document.getElementById('messageBox');
                if (messageBox) {
                    messageBox.textContent = data.message || '...';
                }

                // ë¯¸ë¡œ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                const mazeText = document.querySelector('.maze-text');
                if (mazeText && data.mazeView) {
                    mazeText.textContent = data.mazeView;
                }

                // í”Œë ˆì´ì–´ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                if (data.playerX !== undefined) {
                    const playerXSpan = document.querySelector('.game-info p:nth-child(1) span:nth-child(1)');
                    const playerYSpan = document.querySelector('.game-info p:nth-child(1) span:nth-child(2)');
                    if (playerXSpan) playerXSpan.textContent = data.playerX;
                    if (playerYSpan) playerYSpan.textContent = data.playerY;
                }

                // AI ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                if (data.enemyX !== undefined) {
                    const enemyXSpan = document.querySelector('.game-info p:nth-child(2) span:nth-child(1)');
                    const enemyYSpan = document.querySelector('.game-info p:nth-child(2) span:nth-child(2)');
                    if (enemyXSpan) enemyXSpan.textContent = data.enemyX;
                    if (enemyYSpan) enemyYSpan.textContent = data.enemyY;
                }

                // ê²Œì„ ì™„ë£Œ ì²˜ë¦¬
                if (data.gameFinished) {
                    const gameOverModal = document.getElementById('gameOverModal');
                    if (gameOverModal) {
                        gameOverModal.style.display = 'flex';
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
        document.addEventListener('keydown', function(e) {
            const key = e.key.toLowerCase();
            if (key === 'w' || e.key === 'ArrowUp') {
                e.preventDefault();
                move('w');
            } else if (key === 's' || e.key === 'ArrowDown') {
                e.preventDefault();
                move('s');
            } else if (key === 'a' || e.key === 'ArrowLeft') {
                e.preventDefault();
                move('a');
            } else if (key === 'd' || e.key === 'ArrowRight') {
                e.preventDefault();
                move('d');
            }
        });
        
        // AI ìë™ ì´ë™ (ì •í™•í•œ 0.5ì´ˆ ê°„ê²©)
        let aiMoveInterval = null;
        let lastAiMoveTime = Date.now();
        const AI_MOVE_INTERVAL = 500; // 0.5ì´ˆ
        
        function scheduleNextAiMove() {
            const now = Date.now();
            const elapsed = now - lastAiMoveTime;
            const delay = Math.max(0, AI_MOVE_INTERVAL - elapsed);
            
            aiMoveInterval = setTimeout(function() {
                lastAiMoveTime = Date.now();
                
                fetch('/game/ai-move', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // ê²Œì„ì´ ëë‚¬ìœ¼ë©´ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                        if (data.gameFinished) {
                            if (aiMoveInterval) {
                                clearTimeout(aiMoveInterval);
                            }
                            location.reload();
                        } else {
                            // ë¯¸ë¡œ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                            const mazeText = document.querySelector('.maze-text');
                            if (mazeText && data.mazeView) {
                                mazeText.textContent = data.mazeView;
                            }
                            // ìœ„ì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸
                            if (data.enemyX !== undefined) {
                                const enemyXSpan = document.querySelector('.game-info p:nth-child(2) span:nth-child(1)');
                                const enemyYSpan = document.querySelector('.game-info p:nth-child(2) span:nth-child(2)');
                                if (enemyXSpan) enemyXSpan.textContent = data.enemyX;
                                if (enemyYSpan) enemyYSpan.textContent = data.enemyY;
                            }
                        }
                    }
                    // ë‹¤ìŒ ì´ë™ ìŠ¤ì¼€ì¤„ë§ (ìš”ì²­ ì™„ë£Œ í›„)
                    if (!data.gameFinished) {
                        scheduleNextAiMove();
                    }
                })
                .catch(error => {
                    console.error('AI Move Error:', error);
                    // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ë‹¤ìŒ ì´ë™ ìŠ¤ì¼€ì¤„ë§
                    scheduleNextAiMove();
                });
            }, delay);
        }
        
        // AI ì´ë™ ì‹œì‘
        scheduleNextAiMove();
        
        // ê²Œì„ ì™„ë£Œ í™•ì¸
        const gameFinished = /*[[${status.gameFinished}]]*/ false;
        if (gameFinished) {
            const gameOverModal = document.getElementById('gameOverModal');
            if (gameOverModal) {
                gameOverModal.style.display = 'flex';
            }
            if (aiMoveInterval) {
                clearTimeout(aiMoveInterval);
            }
        }
        
        // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ íƒ€ì´ë¨¸ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            if (aiMoveInterval) {
                clearTimeout(aiMoveInterval);
            }
        });
    </script>
</body>
</html>
